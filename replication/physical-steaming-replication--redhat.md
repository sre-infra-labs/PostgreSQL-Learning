# Steaming Replication on Redhat

```
primary -> pg-pub2 (192.168.100.46)
secondary -> pg-sub2 (192.168.200.46)
```

# Replica Monitoring. Execute on primary
```
select * from pg_stat_replication;
```

# Setup Asynchronous replication environment

## On primary, Set `listen_addresses = '*'` in postgresql.conf

## On primary, Create role for replication
```
--create role replicator with replication encrypted password 'SuperSecret' login;
create role replication with login replication encrypted password 'LearnPostgreSQL';
```

## On primary, add pg_hba.conf entry for replication
```
host    replication     all     0.0.0.0/0     scram-sha-256
```

## On primary, reload configuration
```
sudo systemctl reload postgresql-16.service
or
select pg_reload_conf();
```

## On secondary, remove PGDATA directory, and recreate emptry PGDATA directory with proper permissions
```
cd /var/lib/pgsql/16/
rm -rf data
mkdir data
sudo chown postgres:postgres data
sudo chmod 0700 data
```

## On seconary, create/modify .pgpass file
```
# create pgpass entry
sudo vim /var/lib/pgsql/.pgpass

*:*:replication:replication:LearnPostgreSQL
```

## On primary, set an appropriate value for `wal_keep_segments` in postgresql.conf
```
wal_keep_segments = 500
 -- size = 16 mb * 500 = 8000 mb
```

## On primary, create a slot for replication
```
-- get existing slots
select * from pg_replication_slots;

-- to create slot
select * from pg_create_physical_replication_slot('master');
    or
    -- create slot one per replica
    select * from pg_create_physical_replication_slot('pg-sub2');

-- rollback. to drop slot
select pg_drop_replication_slot('master');
```

## On secondary (pg-sub2), as postgres system user, perform pg_basebackup for primary (pg-pub2)
![replication-slot-and-user.png](replication-slot-and-user.png)
```
sudo su - postgres
cd /var/lib/pgsql/16/data/

# perform physical backup
pg_basebackup -h pg-pub2 -p5432 -U replication -D /var/lib/pgsql/16/data -Fp -Xs -P -R -S master

```

### On secondary, check `postgresql.auto.conf` file content

```
[postgres@pg-sub2 data]$ cat postgresql.auto.conf

# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
shared_preload_libraries = 'pg_stat_statements, auto_explain, pg_cron, pg_stat_monitor, pglogical, pgaudit'
primary_conninfo = 'user=replication passfile=''/var/lib/pgsql/.pgpass'' channel_binding=prefer host=''pg-pub2'' port=5432 sslmode=prefer sslcompression=0 sslcertmode=allow sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres gssdelegation=0 target_session_attrs=any load_balance_hosts=disable'
primary_slot_name = 'master'

```

### pg_basebackup command explanation

| Option                     | Description                                                                                   |
|----------------------------|-----------------------------------------------------------------------------------------------|
| `-h pg-pub2`               | Hostname or IP address of the primary server                                                  |
| `-p 5432`                  | Port on which the primary PostgreSQL server is listening                                      |
| `-U replication`           | PostgreSQL user with `REPLICATION` privilege used to take the backup                         |
| `-D /var/lib/pgsql/16/data`| Destination directory for base backup (must be empty or non-existent)                        |
| `-Fp`                      | Output format: plain (copies full directory structure of the data directory)                 |
| `-Xs`                      | Include WAL (Write-Ahead Log) files using **streaming** method during backup. This opens a second connection to the primary server and starts the transfer of the WAL segments at the same time as the backup is performed.                 |
| `-P`                       | Show progress of the backup operation                                                        |
| `-R`                       | Create `standby.signal` and `primary_conninfo` in postgresql.auto.conf for standby setup     |
| `-S master`                | Use replication slot named `master` (created if doesn't exist on primary)                    |


## On secondary, start the PostgreSQL service now
```
[saanvi@pg-sub2 16]$ sudo systemctl start postgresql-16.service
[saanvi@pg-sub2 16]$ sudo systemctl status postgresql-16.service

● postgresql-16.service - PostgreSQL 16 database server
     Loaded: loaded (/usr/lib/systemd/system/postgresql-16.service; enabled; preset: disabled)
     Active: active (running) since Thu 2025-08-07 13:19:24 IST; 5s ago
       Docs: https://www.postgresql.org/docs/16/static/
    Process: 134469 ExecStartPre=/usr/pgsql-16/bin/postgresql-16-check-db-dir ${PGDATA} (code=exited, status=0/SUCCESS)
   Main PID: 134474 (postgres)
      Tasks: 6 (limit: 48880)
     Memory: 293.0M
        CPU: 334ms
     CGroup: /system.slice/postgresql-16.service
             ├─134474 /usr/pgsql-16/bin/postgres -D /var/lib/pgsql/16/data/
             ├─134475 "postgres: logger "
             ├─134476 "postgres: checkpointer "
             ├─134477 "postgres: background writer "
             ├─134478 "postgres: startup recovering 000000010000000000000005"
             └─134479 "postgres: walreceiver streaming 0/5000148"

Aug 07 13:19:24 pg-sub2 systemd[1]: Starting PostgreSQL 16 database server...
Aug 07 13:19:24 pg-sub2 postgres[134474]: 2025-08-07 13:19:24.563 IST [134474] LOG:  pgaudit extension initialized
Aug 07 13:19:24 pg-sub2 postgres[134474]: 2025-08-07 13:19:24.821 IST [134474] LOG:  redirecting log output to logging collector process
Aug 07 13:19:24 pg-sub2 postgres[134474]: 2025-08-07 13:19:24.821 IST [134474] HINT:  Future log output will appear in directory "log".
Aug 07 13:19:24 pg-sub2 systemd[1]: Started PostgreSQL 16 database server.
```

### Validate by psql connection
```
(base) ----- [2025-Aug-07 13:21:02] saanvi@ryzen9 (Linux-Learning)
|------------$ psql -h pg-sub2 -U postgres
psql (17.5 (Ubuntu 17.5-1.pgdg24.04+1), server 16.9)
Type "help" for help.

postgres=# 
postgres=# select pg_is_in_recovery();
 pg_is_in_recovery 
-------------------
 t
(1 row)

postgres=# 
```

### Validate postgresql logs
```
[postgres@pg-sub2 data]$ 
[postgres@pg-sub2 data]$ tail -5 log/postgresql-Thu.log 

2025-08-07 13:19:24.899 IST [134474] LOG:  database system is ready to accept read-only connections
2025-08-07 13:19:24.993 IST [134479] LOG:  started streaming WAL from primary at 0/5000000 on timeline 1
2025-08-07 13:24:24.840 IST [134476] LOG:  restartpoint starting: time
2025-08-07 13:24:24.845 IST [134476] LOG:  restartpoint complete: wrote 1 buffers (0.0%); 0 WAL file(s) added, 0 removed, 1 recycled; write=0.001 s, sync=0.001 s, total=0.005 s; sync files=0, longest=0.000 s, average=0.000 s; distance=16384 kB, estimate=16384 kB; lsn=0/5000098, redo lsn=0/5000060
2025-08-07 13:24:24.845 IST [134476] LOG:  recovery restart point at 0/5000060
[postgres@pg-sub2 data]$ 
[postgres@pg-sub2 data]$ 
```

### On secondary, Try creating a table
```
postgres=# 
postgres=# create table test_on_secondary (id integer);
ERROR:  cannot execute CREATE TABLE in a read-only transaction
postgres=# 
postgres=# 
```

### On primary, Try creating a table
```
postgres=# \c dba
psql (17.5 (Ubuntu 17.5-1.pgdg24.04+1), server 16.9)
You are now connected to database "dba" as user "postgres".
dba=# 
dba=# create table test_on_primary (id integer);
CREATE TABLE
dba=# 
```

# Synchronous Replication

## On primary, update `postgresql.conf` settings
```
synchronous_commit = on

synchronous_standby_names = 'pg-sub2'
or
synchronous_standby_names = '*'
```

### Restart primary postgresql service
```
sudo systemctl restart postgresql-16.service
```

## On secondary, update `postgresql.auto.conf` file. Append `application_name=<secondary_replica_name>` at the end of `primary_conninfo` setting.
```
# **** Before update
[saanvi@pg-sub2 16]$ sudo cat /var/lib/pgsql/16/data/postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
shared_preload_libraries = 'pg_stat_statements, auto_explain, pg_cron, pg_stat_monitor, pglogical, pgaudit'
primary_conninfo = 'user=replication passfile=''/var/lib/pgsql/.pgpass'' channel_binding=prefer host=''pg-pub2'' port=5432 sslmode=prefer sslcompression=0 sslcertmode=allow sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres gssdelegation=0 target_session_attrs=any load_balance_hosts=disable'
primary_slot_name = 'master'

# **** After Update
[saanvi@pg-sub2 16]$ sudo cat /var/lib/pgsql/16/data/postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
shared_preload_libraries = 'pg_stat_statements, auto_explain, pg_cron, pg_stat_monitor, pglogical, pgaudit'
primary_conninfo = 'user=replication passfile=''/var/lib/pgsql/.pgpass'' channel_binding=prefer host=''pg-pub2'' port=5432 sslmode=prefer sslcompression=0 sslcertmode=allow sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres gssdelegation=0 target_session_attrs=any load_balance_hosts=disable application_name=pg-sub2'
primary_slot_name = 'master'
```

### Restart secondary postgresql service
```
sudo systemctl restart postgresql-16.service
```

### On primary, Verify change by querying
```
select * from pg_stat_replication;


dba=# select * from pg_stat_replication;
-[ RECORD 1 ]----+---------------------------------
pid              | 136516
usesysid         | 17205
usename          | replication
application_name | pg-sub2
client_addr      | 192.168.200.46
client_hostname  | 
client_port      | 33344
backend_start    | 2025-08-07 15:43:24.014093+05:30
backend_xmin     | 
state            | streaming
sent_lsn         | 0/501A240
write_lsn        | 0/501A240
flush_lsn        | 0/501A240
replay_lsn       | 0/501A240
write_lag        | 
flush_lag        | 
replay_lag       | 
sync_priority    | 1
sync_state       | sync
reply_time       | 2025-08-07 15:50:14.231514+05:30

dba=# 
```

